{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertidor de Divisas | NUAM</title>
    <link rel="stylesheet" href="{% static 'divisa.css' %}">
    <link rel="stylesheet" href="{% static 'index.css' %}">
</head>
<body>
    <!-- HEADER: Navegación y Sesión de Usuario -->
    <header class="main-header">
        <nav class="nav-links">
            <a href="{% url 'index' %}" class="nav-link">← Volver al Inicio</a>
        </nav>
        <div class="user-session">
            <span class="session-text">Sesión:</span>
            <span class="username">{{ usuario.nombre }} {{ usuario.apellido }}</span>
            
            <form action="{% url 'logout' %}" method="POST" style="margin: 0;">
                {% csrf_token %}
                <button type="submit" class="btn-logout">CERRAR</button>
            </form>
        </div>
    </header>

    <div class="top-banner"></div>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="container">
        <h1 class="main-title">Convertidor de Divisas</h1>

        <!-- Sección del Conversor -->
        <section class="converter-section">
            <div class="converter-box">
                <h2>Conversión de Monedas en Vivo</h2>

                <div class="converter">
                    <label for="from">Desde:</label>
                    <select id="from">
                        <option value="EUR">EUR - Euro</option>
                        <option value="USD" >USD - Dólar EE.UU.</option>
                        <option value="CLP">CLP - Peso Chileno</option>
                        <option value="COP">COP - Peso colombiano</option>
                        <option value="PEN">PEN - Sol peruano</option>
                    </select>

                    <label for="to">Hacia:</label>
                    <select id="to">
                        <option value="EUR">EUR - Euro</option>
                        <option value="USD">USD - Dólar EE.UU.</option>
                        <option value="CLP" >CLP - Peso Chileno</option>
                        <option value="COP">COP - Peso colombiano</option>
                        <option value="PEN">PEN - Sol peruano</option>
                    </select>

                    <label for="amount">Monto: Ej:10,100,1.000</label>
                    <input type="number" id="amount" placeholder="100" value="100">

                    <button onclick="convert()">Convertir</button>

                    <div id="loading" style="display:none">Convirtiendo...</div>
                    <div id="result"></div>
                    <div id="rate"></div>
                </div>
            </div>
        </section>

        <!-- Sección Quienes Somos -->
        <section id="quienes-somos" class="quienes-somos">
            <h2 class="section-subtitle">¿Por qué usar NUAM?</h2>
            <p class="section-text">
                Nuestro convertidor de divisas en vivo te proporciona tasas de cambio actualizadas en tiempo real, permitiéndote tomar decisiones financieras informadas para tus operaciones tributarias internacionales.
            </p>
            <p class="section-text">
                Integrado con nuestro sistema de gestión tributaria, puedes realizar conversiones rápidas y precisas sin salir de la plataforma.
            </p>
        </section>  
    </main>

    <script>
        async function convert() {
            const from = document.getElementById("from").value;
            const to = document.getElementById("to").value;
            const amount = document.getElementById("amount").value;

            if (!amount || amount <= 0) {
                document.getElementById("result").innerText = "Ingresa un monto válido.";
                return;
            }

            if (from === to) {
                document.getElementById("result").innerText = "Las monedas no pueden ser iguales.";
                return;
            }

            const url = `/api/convert/?from_currency=${from}&to_currency=${to}&amount=${amount}`;

            document.getElementById("loading").style.display = "block";
            document.getElementById("result").innerText = "";
            document.getElementById("rate").innerText = "";

            try {
                const response = await fetch(url);
                const data = await response.json();

                document.getElementById("loading").style.display = "none";

                if (data.error) {
                    document.getElementById("result").innerText = "Error: " + data.error;
                    return;
                }

                const formatted = Number(data.resultado).toLocaleString("es-CL", {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });

                document.getElementById("result").innerText =
                    `${amount} ${from} = ${formatted} ${to}`;

                document.getElementById("rate").innerText =
                    `Tasa utilizada: 1 ${from} = ${data.rate} ${to}`;

            } catch (error) {
                document.getElementById("loading").style.display = "none";
                document.getElementById("result").innerText = "Error al conectar con la API.";
            }
        }
    </script>
</body>
</html>
